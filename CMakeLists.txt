# == DO NOT EDIT THE FOLLOWING LINES for the Raspberry Pi Pico VS Code Extension to work ==
if(WIN32)
    set(USERHOME $ENV{USERPROFILE})
else()
    set(USERHOME $ENV{HOME})
endif()
set(sdkVersion 2.2.0)
set(toolchainVersion 14_2_Rel1)
set(picotoolVersion 2.2.0)
set(picoVscode ${USERHOME}/.pico-sdk/cmake/pico-vscode.cmake)
if (EXISTS ${picoVscode})
    include(${picoVscode})
endif()
# ====================================================================================
cmake_minimum_required(VERSION 3.13)

set(BUILD_NAME "murmapple")

# Set board to Pico 2 (RP2350)
set(PICO_BOARD pico2 CACHE STRING "Board type")

# Board configuration variant (M1, M2)
set(BOARD_VARIANT "M2" CACHE STRING "Board variant: M1 or M2")

# CPU overclock configuration (252, 378, 504 MHz)
set(CPU_SPEED "378" CACHE STRING "CPU clock in MHz: 252, 378, 504")

#set(VIDEO_HDMI ON)
set(VIDEO_VGA ON)

set(PWM_SOUND ON)

# PSRAM speed configuration (84, 100, 133, 166 MHz target)
set(PSRAM_SPEED "84" CACHE STRING "PSRAM max frequency in MHz: 84, 100, 133, 166")

# MOS2 support (generate .m1p2 or m2p2 for Murmulator OS instead of .uf2)
option(MOS2 "Build for Murmulator OS (m1p2/m2p2 format)" OFF)
set(MOS2 ON)

# CPU voltage selection based on speed
if(CPU_SPEED GREATER_EQUAL 504)
    set(CPU_VOLTAGE "VREG_VOLTAGE_1_65")
elseif(CPU_SPEED GREATER_EQUAL 378)
    set(CPU_VOLTAGE "VREG_VOLTAGE_1_60")
else()
    set(CPU_VOLTAGE "VREG_VOLTAGE_1_50")
endif()

# I2S Audio pin configuration based on board variant
if(BOARD_VARIANT STREQUAL "M1")
    set(I2S_DATA_PIN "26")
    set(I2S_CLOCK_PIN_BASE "27")
else()  # M2
    set(I2S_DATA_PIN "9")
    set(I2S_CLOCK_PIN_BASE "10")
endif()

# USB HID Host support (keyboard and gamepad via USB)
# When enabled, USB CDC stdio is disabled!
option(USB_HID_ENABLED "Enable USB HID Host for keyboard/gamepad" ON)

# PS/2 keyboard support toggle
option(PS2_KEYBOARD_ENABLED "Enable PS/2 keyboard input" ON)

# Verbose debug logging toggle
option(DEBUG_LOGS_ENABLED "Enable verbose debug logging" OFF)

message(STATUS "murmapple - Apple IIe Emulator for RP2350")
if (PSRAM_SPEED)
    message(STATUS "Board: ${BOARD_VARIANT}, CPU: ${CPU_SPEED} MHz, PSRAM: ${PSRAM_SPEED} MHz, Voltage: ${CPU_VOLTAGE}")
else ()
    message(STATUS "Board: ${BOARD_VARIANT}, CPU: ${CPU_SPEED} MHz, Voltage: ${CPU_VOLTAGE}")
endif ()
message(STATUS "I2S Audio: DATA=${I2S_DATA_PIN}, CLK_BASE=${I2S_CLOCK_PIN_BASE}")

include(pico_sdk_import.cmake)

# Import pico-extras for audio_i2s library
set(PICO_EXTRAS_PATH ${CMAKE_CURRENT_LIST_DIR}/pico-extras CACHE PATH "Path to pico-extras")
if(EXISTS ${PICO_EXTRAS_PATH}/external/pico_extras_import.cmake)
    include(${PICO_EXTRAS_PATH}/external/pico_extras_import.cmake)
endif()

set(OUTPUT_DIR "${CMAKE_SOURCE_DIR}/bin/${CMAKE_BUILD_TYPE}")
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY "${OUTPUT_DIR}")

if (MOS2)
    IF(BOARD_VARIANT STREQUAL "M2")
        SET(BUILD_NAME "${BUILD_NAME}.m2p2")
# TODO: support later
#    ELSEIF(PICO_PC)
#        SET(BUILD_NAME "${BUILD_NAME}.PCp2")
#    ELSEIF(PICO_DV)
#        SET(BUILD_NAME "${BUILD_NAME}.DVp2")
#    ELSEIF(ZERO2)
#        SET(BUILD_NAME "${BUILD_NAME}.z0p2")
    ELSE()
        SET(BUILD_NAME "${BUILD_NAME}.m1p2")
    ENDIF()
endif ()

project(${BUILD_NAME} C CXX ASM)
set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 17)

pico_sdk_init()

# Initialize pico-extras if available
if(COMMAND pico_extras_init)
    pico_extras_init()
endif()

# Copy driver subdirectories from murmdoom structure
add_subdirectory(drivers/ps2kbd)
add_subdirectory(drivers/fatfs)
add_subdirectory(drivers/sdcard)
if(USB_HID_ENABLED)
    add_subdirectory(drivers/usbhid)
endif()

# Collect driver sources based on configuration
set(DRIVER_SOURCES drivers/nespad/nespad.c)

if (PSRAM_SPEED)
    list(APPEND DRIVER_SOURCES
        drivers/psram_init.c
        drivers/psram_allocator.c
    )
endif()

if (VIDEO_HDMI)
    list(APPEND DRIVER_SOURCES drivers/HDMI.c)
endif()

if (VIDEO_VGA)
    list(APPEND DRIVER_SOURCES drivers/vga.c)
endif()

# Create a library for drivers
add_library(drivers ${DRIVER_SOURCES})

target_include_directories(drivers PUBLIC drivers drivers/nespad src)
target_compile_definitions(drivers PRIVATE
    BOARD_${BOARD_VARIANT}
)

if (PSRAM_SPEED)
    target_compile_definitions(drivers PRIVATE
        PSRAM_MAX_FREQ_MHZ=${PSRAM_SPEED}
    )
endif()

# Apple IIe Emulator sources
add_executable(${BUILD_NAME}
    src/main.c
    src/mii_65c02.c
    src/mii_bank.c
    src/mii_video.c
    src/mii_rom.c
    src/mii.c
    src/mii_rom_iiee.c
    src/mii_rom_iiee_video.c
    src/disk_loader.c
    src/disk_ui.c
    src/mii_startscreen.c
    src/mii_analog.c
    # Disk drive support
    src/mii_slot.c
    src/mii_dd_stub.c
    src/mii_floppy.c
    src/mii_disk2.c
    src/mii_dsk.c
    src/mii_nib.c
    src/mii_woz.c
    src/mii_vcd_stub.c
    src/mii_rom_disk2_p5.c
    # Audio support
    src/mii_audio_i2s.c
    # Note: mii_speaker.c is excluded - stub provided in main.c for RP2350
    src/mockingboard.c
)

if (PICO_BOARD STREQUAL "pico")
    pico_define_boot_stage2(slower_boot2 ${PICO_DEFAULT_BOOT_STAGE2_FILE})
    target_compile_definitions(slower_boot2 PRIVATE PICO_FLASH_SPI_CLKDIV=4)
    pico_set_boot_stage2(${BUILD_NAME} slower_boot2)
    unset(MOS2)
else()
    # RP2350: Use custom linker scripts
    # MOS2 builds use memmap.mos2.ld, regular UF2 builds use memmap.ld
    if (MOS2)
        pico_set_linker_script(${PROJECT_NAME} "${CMAKE_SOURCE_DIR}/memmap.mos2.ld")
    else()
        pico_set_linker_script(${PROJECT_NAME} "${CMAKE_SOURCE_DIR}/memmap.ld")
    endif()
endif()

target_link_libraries(drivers pico_stdlib hardware_dma hardware_pio hardware_spi hardware_pwm)

target_include_directories(${BUILD_NAME} PRIVATE
    src
    drivers
)

target_compile_definitions(${BUILD_NAME} PRIVATE
    BOARD_${BOARD_VARIANT}
    CPU_CLOCK_MHZ=${CPU_SPEED}
    CPU_VOLTAGE=${CPU_VOLTAGE}
    MII_65C02_DIRECT_ACCESS=1
    MII_RP2350=1
    # I2S Audio configuration
    # NOTE: HDMI uses PIO1, PS/2 uses PIO0 SM0 (claimed dynamically)
    # So I2S uses PIO0 SM2 (claimed statically before PS/2 init)
    PICO_AUDIO_I2S_PIO=0
    PICO_AUDIO_I2S_STATE_MACHINE=2
    PICO_AUDIO_I2S_DMA_IRQ=1
    PICO_AUDIO_I2S_DMA_CHANNEL=10
    PICO_AUDIO_I2S_DATA_PIN=${I2S_DATA_PIN}
    PICO_AUDIO_I2S_CLOCK_PIN_BASE=${I2S_CLOCK_PIN_BASE}
)
if (PWM_SOUND)
    target_compile_definitions(${BUILD_NAME} PRIVATE FEATURE_AUDIO_PWM=1)
else()
    target_compile_definitions(${BUILD_NAME} PRIVATE FEATURE_AUDIO_I2S=1)
endif()

if (PICO_BOARD STREQUAL "pico2")
    if (PSRAM_SPEED)
        target_compile_definitions(${BUILD_NAME} PRIVATE
            PSRAM_MAX_FREQ_MHZ=${PSRAM_SPEED}
        )
    endif()
endif()

if (VIDEO_HDMI)
    target_compile_definitions(${BUILD_NAME} PRIVATE
        VIDEO_HDMI
        VIDEO=HDMI
    )
endif()

if (VIDEO_VGA)
    target_compile_definitions(${BUILD_NAME} PRIVATE
        VIDEO_VGA
        VIDEO=VGA
    )
endif()

if(PS2_KEYBOARD_ENABLED)
    target_compile_definitions(${BUILD_NAME} PRIVATE ENABLE_PS2_KEYBOARD=1)
else()
    target_compile_definitions(${BUILD_NAME} PRIVATE ENABLE_PS2_KEYBOARD=0)
endif()

if(DEBUG_LOGS_ENABLED)
    target_compile_definitions(${BUILD_NAME} PRIVATE ENABLE_DEBUG_LOGS=1)
else()
    target_compile_definitions(${BUILD_NAME} PRIVATE ENABLE_DEBUG_LOGS=0)
endif()

# Optimization for maximum performance on RP2350
# -O3: Maximum optimization including loop vectorization
# -ffunction-sections -fdata-sections: Allow linker to remove unused code
# -flto: Link-time optimization for cross-file inlining
# -fno-strict-aliasing: Allow type punning (common in emulators)
# -march=armv8-m.main+fp+dsp: Target Cortex-M33 architecture
target_compile_options(${BUILD_NAME} PRIVATE 
    -O3
    -ffunction-sections 
    -fdata-sections
    -fno-strict-aliasing
)

target_link_libraries(${BUILD_NAME}
    pico_stdlib
    pico_multicore
    pico_audio_i2s
    hardware_dma
    hardware_pio
    hardware_clocks
    hardware_vreg
    hardware_spi
    drivers
    ps2kbd
    sdcard
    fatfs
)

if(USB_HID_ENABLED)
    target_link_libraries(${BUILD_NAME} usbhid)
endif()

# USB CDC stdio: enabled for debugging, but disabled when USB HID is enabled
# (USB port can only be Host OR Device, not both)
if(USB_HID_ENABLED)
    pico_enable_stdio_usb(${BUILD_NAME} 0)
    message(STATUS "USB CDC stdio disabled (USB HID Host is enabled)")
else()
    pico_enable_stdio_usb(${BUILD_NAME} 1)
endif()
pico_enable_stdio_uart(${BUILD_NAME} 1)

# Create UF2 output
pico_add_extra_outputs(${BUILD_NAME})

target_link_options(${BUILD_NAME} PRIVATE -Xlinker --print-memory-usage --data-sections)

# MOS2 support:
if (MOS2)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E rename
        "${OUTPUT_DIR}/${BUILD_NAME}.uf2"
        "${OUTPUT_DIR}/${BUILD_NAME}"
    )
endif ()
