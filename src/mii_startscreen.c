/*
 * mii_startscreen.c
 *
 * Start screen display for MurmApple before emulator initialization
 * Renders directly to HDMI framebuffer using same style as disk_ui
 * 
 * Developed by Mikhail Matveev, rh1.tech
 */
#include "mii_startscreen.h"
#include "debug_log.h"
#include "HDMI.h"
#include "pico/time.h"
#include <stdio.h>
#include <string.h>

// Get actual screen dimensions from HDMI driver
#define SCREEN_WIDTH  320
#define SCREEN_HEIGHT 240

// UI dimensions
#define CHAR_WIDTH      6
#define CHAR_HEIGHT     8
#define HEADER_HEIGHT   12
#define LINE_HEIGHT     10
#define UI_PADDING      8

// Colors (palette indices)
#define COLOR_BG        0   // Black
#define COLOR_BORDER    15  // White
#define COLOR_TEXT      15  // White
#define COLOR_HEADER_BG 15  // White (for inverted header)
#define COLOR_HEADER_FG 0   // Black (for inverted header)
#define COLOR_GREEN     12  // Light Green

// Compact 6x8 bitmap font (same as disk_ui)
static const uint8_t font_6x8[][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 32 Space
    {0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00}, // 33 !
    {0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00}, // 34 "
    {0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x00}, // 35 #
    {0x20,0x78,0xA0,0x70,0x28,0xF0,0x20,0x00}, // 36 $
    {0xC0,0xC8,0x10,0x20,0x40,0x98,0x18,0x00}, // 37 %
    {0x40,0xA0,0xA0,0x40,0xA8,0x90,0x68,0x00}, // 38 &
    {0x20,0x20,0x40,0x00,0x00,0x00,0x00,0x00}, // 39 '
    {0x10,0x20,0x40,0x40,0x40,0x20,0x10,0x00}, // 40 (
    {0x40,0x20,0x10,0x10,0x10,0x20,0x40,0x00}, // 41 )
    {0x00,0x20,0xA8,0x70,0xA8,0x20,0x00,0x00}, // 42 *
    {0x00,0x20,0x20,0xF8,0x20,0x20,0x00,0x00}, // 43 +
    {0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x40}, // 44 ,
    {0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00}, // 45 -
    {0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00}, // 46 .
    {0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00}, // 47 /
    {0x70,0x88,0x98,0xA8,0xC8,0x88,0x70,0x00}, // 48 0
    {0x20,0x60,0x20,0x20,0x20,0x20,0x70,0x00}, // 49 1
    {0x70,0x88,0x08,0x30,0x40,0x80,0xF8,0x00}, // 50 2
    {0x70,0x88,0x08,0x30,0x08,0x88,0x70,0x00}, // 51 3
    {0x10,0x30,0x50,0x90,0xF8,0x10,0x10,0x00}, // 52 4
    {0xF8,0x80,0xF0,0x08,0x08,0x88,0x70,0x00}, // 53 5
    {0x30,0x40,0x80,0xF0,0x88,0x88,0x70,0x00}, // 54 6
    {0xF8,0x08,0x10,0x20,0x40,0x40,0x40,0x00}, // 55 7
    {0x70,0x88,0x88,0x70,0x88,0x88,0x70,0x00}, // 56 8
    {0x70,0x88,0x88,0x78,0x08,0x10,0x60,0x00}, // 57 9
    {0x00,0x00,0x20,0x00,0x00,0x20,0x00,0x00}, // 58 :
    {0x00,0x00,0x20,0x00,0x00,0x20,0x20,0x40}, // 59 ;
    {0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x00}, // 60 <
    {0x00,0x00,0xF8,0x00,0xF8,0x00,0x00,0x00}, // 61 =
    {0x40,0x20,0x10,0x08,0x10,0x20,0x40,0x00}, // 62 >
    {0x70,0x88,0x10,0x20,0x20,0x00,0x20,0x00}, // 63 ?
    {0x70,0x88,0xB8,0xA8,0xB8,0x80,0x70,0x00}, // 64 @
    {0x70,0x88,0x88,0xF8,0x88,0x88,0x88,0x00}, // 65 A
    {0xF0,0x88,0x88,0xF0,0x88,0x88,0xF0,0x00}, // 66 B
    {0x70,0x88,0x80,0x80,0x80,0x88,0x70,0x00}, // 67 C
    {0xE0,0x90,0x88,0x88,0x88,0x90,0xE0,0x00}, // 68 D
    {0xF8,0x80,0x80,0xF0,0x80,0x80,0xF8,0x00}, // 69 E
    {0xF8,0x80,0x80,0xF0,0x80,0x80,0x80,0x00}, // 70 F
    {0x70,0x88,0x80,0xB8,0x88,0x88,0x70,0x00}, // 71 G
    {0x88,0x88,0x88,0xF8,0x88,0x88,0x88,0x00}, // 72 H
    {0x70,0x20,0x20,0x20,0x20,0x20,0x70,0x00}, // 73 I
    {0x38,0x10,0x10,0x10,0x90,0x90,0x60,0x00}, // 74 J
    {0x88,0x90,0xA0,0xC0,0xA0,0x90,0x88,0x00}, // 75 K
    {0x80,0x80,0x80,0x80,0x80,0x80,0xF8,0x00}, // 76 L
    {0x88,0xD8,0xA8,0xA8,0x88,0x88,0x88,0x00}, // 77 M
    {0x88,0xC8,0xA8,0x98,0x88,0x88,0x88,0x00}, // 78 N
    {0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00}, // 79 O
    {0xF0,0x88,0x88,0xF0,0x80,0x80,0x80,0x00}, // 80 P
    {0x70,0x88,0x88,0x88,0xA8,0x90,0x68,0x00}, // 81 Q
    {0xF0,0x88,0x88,0xF0,0xA0,0x90,0x88,0x00}, // 82 R
    {0x70,0x88,0x80,0x70,0x08,0x88,0x70,0x00}, // 83 S
    {0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x00}, // 84 T
    {0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00}, // 85 U
    {0x88,0x88,0x88,0x88,0x50,0x50,0x20,0x00}, // 86 V
    {0x88,0x88,0x88,0xA8,0xA8,0xD8,0x88,0x00}, // 87 W
    {0x88,0x88,0x50,0x20,0x50,0x88,0x88,0x00}, // 88 X
    {0x88,0x88,0x50,0x20,0x20,0x20,0x20,0x00}, // 89 Y
    {0xF8,0x08,0x10,0x20,0x40,0x80,0xF8,0x00}, // 90 Z
    {0x70,0x40,0x40,0x40,0x40,0x40,0x70,0x00}, // 91 [
    {0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00}, // 92 backslash
    {0x70,0x10,0x10,0x10,0x10,0x10,0x70,0x00}, // 93 ]
    {0x20,0x50,0x88,0x00,0x00,0x00,0x00,0x00}, // 94 ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8}, // 95 _
    {0x40,0x20,0x10,0x00,0x00,0x00,0x00,0x00}, // 96 `
    {0x00,0x00,0x70,0x08,0x78,0x88,0x78,0x00}, // 97 a
    {0x80,0x80,0xB0,0xC8,0x88,0xC8,0xB0,0x00}, // 98 b
    {0x00,0x00,0x70,0x80,0x80,0x88,0x70,0x00}, // 99 c
    {0x08,0x08,0x68,0x98,0x88,0x98,0x68,0x00}, // 100 d
    {0x00,0x00,0x70,0x88,0xF8,0x80,0x70,0x00}, // 101 e
    {0x30,0x48,0x40,0xE0,0x40,0x40,0x40,0x00}, // 102 f
    {0x00,0x00,0x68,0x98,0x98,0x68,0x08,0x70}, // 103 g
    {0x80,0x80,0xB0,0xC8,0x88,0x88,0x88,0x00}, // 104 h
    {0x20,0x00,0x60,0x20,0x20,0x20,0x70,0x00}, // 105 i
    {0x10,0x00,0x30,0x10,0x10,0x90,0x60,0x00}, // 106 j
    {0x80,0x80,0x90,0xA0,0xC0,0xA0,0x90,0x00}, // 107 k
    {0x60,0x20,0x20,0x20,0x20,0x20,0x70,0x00}, // 108 l
    {0x00,0x00,0xD0,0xA8,0xA8,0xA8,0xA8,0x00}, // 109 m
    {0x00,0x00,0xB0,0xC8,0x88,0x88,0x88,0x00}, // 110 n
    {0x00,0x00,0x70,0x88,0x88,0x88,0x70,0x00}, // 111 o
    {0x00,0x00,0xB0,0xC8,0xC8,0xB0,0x80,0x80}, // 112 p
    {0x00,0x00,0x68,0x98,0x98,0x68,0x08,0x08}, // 113 q
    {0x00,0x00,0xB0,0xC8,0x80,0x80,0x80,0x00}, // 114 r
    {0x00,0x00,0x78,0x80,0x70,0x08,0xF0,0x00}, // 115 s
    {0x40,0x40,0xE0,0x40,0x40,0x48,0x30,0x00}, // 116 t
    {0x00,0x00,0x88,0x88,0x88,0x98,0x68,0x00}, // 117 u
    {0x00,0x00,0x88,0x88,0x88,0x50,0x20,0x00}, // 118 v
    {0x00,0x00,0x88,0xA8,0xA8,0xA8,0x50,0x00}, // 119 w
    {0x00,0x00,0x88,0x50,0x20,0x50,0x88,0x00}, // 120 x
    {0x00,0x00,0x88,0x88,0x98,0x68,0x08,0x70}, // 121 y
    {0x00,0x00,0xF8,0x10,0x20,0x40,0xF8,0x00}, // 122 z
    {0x10,0x20,0x20,0x40,0x20,0x20,0x10,0x00}, // 123 {
    {0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00}, // 124 |
    {0x40,0x20,0x20,0x10,0x20,0x20,0x40,0x00}, // 125 }
    {0x00,0x00,0x40,0xA8,0x10,0x00,0x00,0x00}, // 126 ~
};

//=============================================================================
// Drawing primitives (same style as disk_ui)
//=============================================================================

static inline void put_pixel_4bpp(uint8_t *fb, uint32_t pix_idx, uint8_t color) {
    uint8_t *p = &fb[pix_idx >> 1];
    if (pix_idx & 1) {
        // high nibble
        *p = (*p & 0x0F) | (color << 4);
    } else {
        // low nibble
        *p = (*p & 0xF0) | color;
    }
}

// Draw a filled rectangle
static void draw_rect(uint8_t *fb, int fb_width, int x, int y, int w, int h, uint8_t color) {
    const int screen_h = SCREEN_HEIGHT;
    for (int dy = 0; dy < h; dy++) {
        if (y + dy < 0 || y + dy >= screen_h) continue;
        for (int dx = 0; dx < w; dx++) {
            if (x + dx < 0 || x + dx >= fb_width) continue;
            put_pixel_4bpp(fb, (y + dy) * fb_width + (x + dx), color);
        }
    }
}

// Draw a character using the 6x8 bitmap font
static void draw_char(uint8_t *fb, int fb_width, int x, int y, char c, uint8_t color) {
    const int screen_h = SCREEN_HEIGHT;
    int idx = (unsigned char)c - 32;
    if (idx < 0 || idx > 94) return;
    
    const uint8_t *glyph = font_6x8[idx];
    
    for (int row = 0; row < 8; row++) {
        if (y + row < 0 || y + row >= screen_h) continue;
        uint8_t bits = glyph[row];
        for (int col = 0; col < 6; col++) {
            if (x + col < 0 || x + col >= fb_width) continue;
            if (bits & (0x80 >> col)) {
                put_pixel_4bpp(fb, (y + row) * fb_width + (x + col), color);
            }
        }
    }
}

// Draw a string
static void draw_string(uint8_t *fb, int fb_width, int x, int y, const char *str, uint8_t color) {
    while (*str) {
        draw_char(fb, fb_width, x, y, *str, color);
        x += CHAR_WIDTH;
        str++;
    }
}

// Get string width in pixels
static int string_width(const char *str) {
    int len = 0;
    while (*str++) len++;
    return len * CHAR_WIDTH;
}

// Draw a border frame
static void draw_border(uint8_t *fb, int fb_width, int x, int y, int w, int h) {
    // Top and bottom
    draw_rect(fb, fb_width, x, y, w, 1, COLOR_BORDER);
    draw_rect(fb, fb_width, x, y + h - 1, w, 1, COLOR_BORDER);
    // Left and right
    draw_rect(fb, fb_width, x, y, 1, h, COLOR_BORDER);
    draw_rect(fb, fb_width, x + w - 1, y, 1, h, COLOR_BORDER);
}

// Draw inverted header bar (Mac-style)
static void draw_header(uint8_t *fb, int fb_width, int x, int y, int w, const char *title) {
    // White background
    draw_rect(fb, fb_width, x, y, w, HEADER_HEIGHT, COLOR_HEADER_BG);
    
    // Center the title
    int title_len = string_width(title);
    int title_x = x + (w - title_len) / 2;
    int title_y = y + (HEADER_HEIGHT - CHAR_HEIGHT) / 2;
    
    // Black text on white background
    draw_string(fb, fb_width, title_x, title_y, title, COLOR_HEADER_FG);
}

// Draw centered text
static void draw_centered_string(uint8_t *fb, int fb_width, int y, const char *str, uint8_t color) {
    int w = string_width(str);
    int x = (fb_width - w) / 2;
    draw_string(fb, fb_width, x, y, str, color);
}

//=============================================================================
// Start screen implementation
//=============================================================================
int mii_startscreen_show(mii_startscreen_info_t *info) {
    if (!info) {
        MII_DEBUG_PRINTF("Start screen: info is NULL\n");
        return -1;
    }
    
    MII_DEBUG_PRINTF("Start screen: Getting graphics buffer...\n");
    uint8_t *buffer = graphics_get_buffer();
    if (!buffer) {
        MII_DEBUG_PRINTF("Start screen: No graphics buffer available\n");
        return -1;
    }
    
    const int screen_w = SCREEN_WIDTH;
    const int screen_h = SCREEN_HEIGHT;
    const int buffer_size = screen_w * screen_h / 2;
    MII_DEBUG_PRINTF("Start screen: screen=%dx%d\n", screen_w, screen_h);
    
    // Clear screen to black
    memset(buffer, COLOR_BG, buffer_size);
    
    // Window dimensions - centered dialog
    const int win_w = 200;
    const int win_h = 130;
    const int win_x = (screen_w - win_w) / 2;
    const int win_y = (screen_h - win_h) / 2;
    
    // Draw window background (black)
    draw_rect(buffer, screen_w, win_x, win_y, win_w, win_h, COLOR_BG);
    
    // Draw window border
    draw_border(buffer, screen_w, win_x, win_y, win_w, win_h);
    
    // Draw title bar with inverted colors
    draw_header(buffer, screen_w, win_x + 1, win_y + 1, win_w - 2, info->title);
    
    // Content area starts after header
    int content_y = win_y + HEADER_HEIGHT + UI_PADDING;
    
    // Draw subtitle
    draw_centered_string(buffer, screen_w, content_y, info->subtitle, COLOR_TEXT);
    content_y += LINE_HEIGHT + 2;
    
    // Draw version
    draw_centered_string(buffer, screen_w, content_y, info->version, COLOR_GREEN);
    content_y += LINE_HEIGHT + 8;
    
    // Draw system info
    char line[48];
    
    snprintf(line, sizeof(line), "CPU: %lu MHz", info->cpu_mhz);
    draw_centered_string(buffer, screen_w, content_y, line, COLOR_TEXT);
    content_y += LINE_HEIGHT;

#if PSRAM_MAX_FREQ_MHZ
    snprintf(line, sizeof(line), "PSRAM: %lu MHz", info->psram_mhz);
    draw_centered_string(buffer, screen_w, content_y, line, COLOR_TEXT);
    content_y += LINE_HEIGHT;
#endif

    snprintf(line, sizeof(line), "Board: M%d", info->board_variant);
    draw_centered_string(buffer, screen_w, content_y, line, COLOR_TEXT);
    
    // Draw copyright at bottom of window
    content_y = win_y + win_h - LINE_HEIGHT * 2 - 6;
    draw_centered_string(buffer, screen_w, content_y, "By Mikhail Matveev, rh1.tech", COLOR_TEXT);
    
    // Draw "Initializing..." at very bottom
    content_y = win_y + win_h - LINE_HEIGHT - 4;
    draw_centered_string(buffer, screen_w, content_y, "Initializing...", COLOR_GREEN);
    
    MII_DEBUG_PRINTF("Start screen: Rendered, waiting 3s...\n");
    
    // Show for 3 seconds
    sleep_ms(3000);
    
    MII_DEBUG_PRINTF("Start screen: Complete\n");
    
    return 0;
}
